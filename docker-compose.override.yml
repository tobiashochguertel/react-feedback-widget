# =============================================================================
# Docker Compose Override - Development Configuration
# =============================================================================
# Automatically merged with docker-compose.yml when running:
#   docker compose up -d
#
# Includes:
# - Source code volume mounts for hot reload
# - Debug logging
# - Faster health check intervals
# - Additional exposed ports for debugging
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database (Development Overrides)
  # ---------------------------------------------------------------------------
  postgres:
    ports:
      - '${POSTGRES_PORT:-18229}:5432'
    healthcheck:
      interval: 5s
      start_period: 5s

  # ---------------------------------------------------------------------------
  # Feedback Server (Development Overrides)
  # ---------------------------------------------------------------------------
  feedback-server:
    build:
      context: .
      dockerfile: packages/feedback-server/Dockerfile
      target: builder # Use builder stage for development
    volumes:
      # Mount source code for hot reload
      - ./packages/feedback-server/src:/app/packages/feedback-server/src:ro
      # Mount OpenAPI spec for API documentation
      - ./packages/generated/openapi:/app/packages/generated/openapi:ro
      # Persist data during development
      - feedback-data:/app/data
      - feedback-uploads:/app/uploads
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
      RUN_MIGRATIONS: 'true'
    working_dir: /app/packages/feedback-server
    command: ['bun', 'run', '--watch', 'src/index.ts']
    healthcheck:
      # Increased start_period to give Bun watch mode time to start
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Feedback WebUI (Development Overrides)
  # ---------------------------------------------------------------------------
  feedback-webui:
    build:
      context: .
      dockerfile: packages/feedback-server-webui/Dockerfile
      target: builder
    volumes:
      # Mount source code for hot reload
      - ./packages/feedback-server-webui/src:/app/packages/feedback-server-webui/src:ro
      - ./packages/feedback-server-webui/public:/app/packages/feedback-server-webui/public:ro
    environment:
      NODE_ENV: development
    working_dir: /app/packages/feedback-server-webui
    command: ['bun', 'run', 'dev', '--host', '0.0.0.0']
    healthcheck:
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Feedback Example (Development Overrides)
  # ---------------------------------------------------------------------------
  # NOTE: feedback-example Dockerfile uses /workspace instead of /app
  # to support Next.js standalone build with workspace resolution
  feedback-example:
    build:
      context: .
      dockerfile: packages/feedback-example/Dockerfile
      target: builder
    volumes:
      # Mount source code for hot reload
      # NOTE: Path is /workspace not /app (matches Dockerfile structure)
      - ./packages/feedback-example/src:/workspace/packages/feedback-example/src:ro
      - ./packages/feedback-example/public:/workspace/packages/feedback-example/public:ro
    environment:
      NODE_ENV: development
    working_dir: /workspace/packages/feedback-example
    command: ['bun', 'run', 'dev']
    healthcheck:
      # Next.js dev server takes longer to compile initially
      interval: 10s
      timeout: 15s
      retries: 5
      start_period: 45s
