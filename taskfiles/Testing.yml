# ============================================================================
# Shared Taskfile: Test Utilities
# ============================================================================
#
# This taskfile provides reusable testing utilities for all packages.
#
# Usage:
#   includes:
#     testing:
#       taskfile: ../../taskfiles/Testing.yml
#
# ============================================================================

version: '3'

vars:
  # Test configuration - override when including
  TEST_BASE_URL: '{{default "http://localhost:3001" .TEST_BASE_URL}}'
  TEST_TIMEOUT: '{{default "30000" .TEST_TIMEOUT}}'

tasks:
  # ============================================================================
  # Test Runners
  # ============================================================================

  unit:
    desc: Run unit tests
    cmds:
      - bun vitest run tests/unit

  integration:
    desc: Run integration tests
    env:
      TEST_BASE_URL: '{{.TEST_BASE_URL}}'
    cmds:
      - bun vitest run tests/integration

  bdd:
    desc: Run BDD tests
    env:
      TEST_BASE_URL: '{{.TEST_BASE_URL}}'
    cmds:
      - bun vitest run tests/bdd

  e2e:
    desc: Run E2E tests
    env:
      TEST_BASE_URL: '{{.TEST_BASE_URL}}'
    cmds:
      - bun vitest run tests/e2e

  all:
    desc: Run all tests
    env:
      TEST_BASE_URL: '{{.TEST_BASE_URL}}'
    cmds:
      - bun vitest run

  watch:
    desc: Run tests in watch mode
    env:
      TEST_BASE_URL: '{{.TEST_BASE_URL}}'
    cmds:
      - bun vitest

  coverage:
    desc: Run tests with coverage
    env:
      TEST_BASE_URL: '{{.TEST_BASE_URL}}'
    cmds:
      - bun vitest run --coverage

  # ============================================================================
  # Test Reports
  # ============================================================================

  report:
    desc: Open test coverage report
    cmds:
      - |
        if [ -f coverage/index.html ]; then
          open coverage/index.html 2>/dev/null || xdg-open coverage/index.html 2>/dev/null || echo "Open coverage/index.html in your browser"
        else
          echo "âŒ No coverage report found. Run 'task testing:coverage' first."
          exit 1
        fi
    silent: true
