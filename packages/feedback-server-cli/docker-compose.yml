# =============================================================================
# Feedback Server CLI - Docker Compose Configuration
# =============================================================================
# Build cross-platform CLI binaries and run the CLI in a container.
#
# Usage:
#   docker compose up build           # Build all binaries
#   docker compose run cli --help     # Run CLI command
#   docker compose run test           # Run tests
#   docker compose run --rm shell     # Open interactive shell
# =============================================================================

name: feedback-server-cli

services:
  # ---------------------------------------------------------------------------
  # Build - Build CLI binaries
  # ---------------------------------------------------------------------------
  build:
    build:
      context: ../..
      dockerfile: packages/feedback-server-cli/Dockerfile
      target: binary-builder
    image: feedback-cli/builder:${DOCKER_IMAGE_TAG:-latest}
    volumes:
      - binaries-output:/app/packages/feedback-server-cli/bin
    command: ['ls', '-la', 'bin/']

  # ---------------------------------------------------------------------------
  # CLI - Run the CLI tool
  # ---------------------------------------------------------------------------
  cli:
    build:
      context: ../..
      dockerfile: packages/feedback-server-cli/Dockerfile
      target: runner
    image: feedback-cli/cli:${DOCKER_IMAGE_TAG:-latest}
    environment:
      FEEDBACK_SERVER_URL: ${FEEDBACK_SERVER_URL:-http://localhost:3001}
      FEEDBACK_API_KEY: ${FEEDBACK_API_KEY:-}
    volumes:
      - cli-config:/home/appuser/.config/feedback-cli

  # ---------------------------------------------------------------------------
  # Test - Run unit tests
  # ---------------------------------------------------------------------------
  test:
    build:
      context: ../..
      dockerfile: packages/feedback-server-cli/Dockerfile
      target: test
    image: feedback-cli/test:${DOCKER_IMAGE_TAG:-latest}
    environment:
      CI: 'true'
    command: ['bun', 'run', 'test']

  # ---------------------------------------------------------------------------
  # Shell - Interactive development shell
  # ---------------------------------------------------------------------------
  shell:
    build:
      context: ../..
      dockerfile: packages/feedback-server-cli/Dockerfile
      target: deps
    image: feedback-cli/deps:${DOCKER_IMAGE_TAG:-latest}
    stdin_open: true
    tty: true
    working_dir: /app/packages/feedback-server-cli
    volumes:
      - ../..:/app
      - node_modules:/app/node_modules
    command: ['/bin/bash']

  # ---------------------------------------------------------------------------
  # Extract - Extract built binaries to host
  # ---------------------------------------------------------------------------
  extract:
    build:
      context: ../..
      dockerfile: packages/feedback-server-cli/Dockerfile
      target: binaries
    image: feedback-cli/binaries:${DOCKER_IMAGE_TAG:-latest}
    volumes:
      - ./bin:/output
    command: ['sh', '-c', 'cp -r /binaries/* /output/ && ls -la /output/']

# =============================================================================
# Volumes
# =============================================================================
volumes:
  binaries-output:
    name: feedback-cli-binaries
  cli-config:
    name: feedback-cli-config
  node_modules:
    name: feedback-cli-node-modules
