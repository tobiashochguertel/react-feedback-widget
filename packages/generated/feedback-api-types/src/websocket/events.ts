/**
 * WebSocket Server Events - TypeScript Types
 *
 * DO NOT EDIT THIS FILE DIRECTLY
 * These types are derived from TypeSpec definitions in:
 * - packages/feedback-server-api/typespec/websocket/events.tsp
 *
 * Run `bun run generate:types` to regenerate if TypeSpec changes.
 *
 * @module @feedback/api-types/websocket/events
 */

import type { components } from '../api-types.js';

/** Feedback type from the generated OpenAPI types */
export type Feedback = components['schemas']['Models.Feedback'];

// ============================================================================
// Server Event Types (Server â†’ Client)
// ============================================================================

/**
 * Base interface for all server events
 */
export interface BaseServerEvent {
  /** Event type discriminator */
  type: string;
  /** ISO 8601 timestamp when event occurred */
  timestamp: string;
}

/**
 * Emitted when a new feedback item is created
 */
export interface FeedbackCreatedEvent extends BaseServerEvent {
  type: 'feedback.created';
  /** The created feedback item */
  feedback: Feedback;
}

/**
 * Emitted when a feedback item is updated
 */
export interface FeedbackUpdatedEvent extends BaseServerEvent {
  type: 'feedback.updated';
  /** The updated feedback item */
  feedback: Feedback;
  /** List of fields that were changed */
  changedFields: string[];
}

/**
 * Emitted when a feedback item is deleted
 */
export interface FeedbackDeletedEvent extends BaseServerEvent {
  type: 'feedback.deleted';
  /** ID of the deleted feedback */
  feedbackId: string;
}

/**
 * Bulk update action types
 */
export type BulkUpdateAction =
  | 'status_change'
  | 'priority_change'
  | 'assignee_change'
  | 'tag_add'
  | 'tag_remove'
  | 'archive'
  | 'unarchive';

/**
 * Emitted when multiple feedback items are updated in bulk
 */
export interface FeedbackBulkUpdateEvent extends BaseServerEvent {
  type: 'feedback.bulk_update';
  /** IDs of updated feedback items */
  feedbackIds: string[];
  /** Action that was performed */
  action: BulkUpdateAction;
}

/**
 * Emitted when WebSocket connection is established
 */
export interface ConnectionAckEvent extends BaseServerEvent {
  type: 'connection.ack';
  /** Unique connection identifier assigned by server */
  connectionId: string;
  /** Server version for compatibility checking */
  serverVersion: string;
}

/**
 * Emitted when subscription is successfully confirmed
 */
export interface SubscriptionConfirmedEvent extends BaseServerEvent {
  type: 'subscription.confirmed';
  /** Channel that was subscribed to */
  channel: string;
}

/**
 * Error codes for WebSocket error events
 */
export type WebSocketErrorCode =
  | 'INVALID_MESSAGE'
  | 'UNAUTHORIZED'
  | 'SUBSCRIPTION_FAILED'
  | 'RATE_LIMITED'
  | 'INTERNAL_ERROR';

/**
 * Emitted when an error occurs
 */
export interface ErrorEvent extends BaseServerEvent {
  type: 'error';
  /** Error code for programmatic handling */
  code: WebSocketErrorCode;
  /** Human-readable error message */
  message: string;
  /** Optional additional details */
  details?: Record<string, unknown>;
}

/**
 * Response to ping command (keep-alive)
 */
export interface PongEvent extends BaseServerEvent {
  type: 'pong';
}

// ============================================================================
// Union Types
// ============================================================================

/**
 * All possible server event types
 *
 * Use this type for type-safe event handling:
 * ```typescript
 * function handleEvent(event: ServerEvent) {
 *   switch (event.type) {
 *     case 'feedback.created':
 *       // TypeScript knows event is FeedbackCreatedEvent
 *       console.log(event.feedback);
 *       break;
 *   }
 * }
 * ```
 */
export type ServerEvent =
  | FeedbackCreatedEvent
  | FeedbackUpdatedEvent
  | FeedbackDeletedEvent
  | FeedbackBulkUpdateEvent
  | ConnectionAckEvent
  | SubscriptionConfirmedEvent
  | ErrorEvent
  | PongEvent;

/**
 * Map of event type strings to event interfaces
 * Useful for type-safe event handler maps
 */
export interface ServerEventMap {
  'feedback.created': FeedbackCreatedEvent;
  'feedback.updated': FeedbackUpdatedEvent;
  'feedback.deleted': FeedbackDeletedEvent;
  'feedback.bulk_update': FeedbackBulkUpdateEvent;
  'connection.ack': ConnectionAckEvent;
  'subscription.confirmed': SubscriptionConfirmedEvent;
  error: ErrorEvent;
  pong: PongEvent;
}

/**
 * All server event type strings
 */
export type ServerEventType = keyof ServerEventMap;

// ============================================================================
// Type Guards
// ============================================================================

/**
 * Type guard for FeedbackCreatedEvent
 */
export function isFeedbackCreatedEvent(event: ServerEvent): event is FeedbackCreatedEvent {
  return event.type === 'feedback.created';
}

/**
 * Type guard for FeedbackUpdatedEvent
 */
export function isFeedbackUpdatedEvent(event: ServerEvent): event is FeedbackUpdatedEvent {
  return event.type === 'feedback.updated';
}

/**
 * Type guard for FeedbackDeletedEvent
 */
export function isFeedbackDeletedEvent(event: ServerEvent): event is FeedbackDeletedEvent {
  return event.type === 'feedback.deleted';
}

/**
 * Type guard for FeedbackBulkUpdateEvent
 */
export function isFeedbackBulkUpdateEvent(event: ServerEvent): event is FeedbackBulkUpdateEvent {
  return event.type === 'feedback.bulk_update';
}

/**
 * Type guard for ConnectionAckEvent
 */
export function isConnectionAckEvent(event: ServerEvent): event is ConnectionAckEvent {
  return event.type === 'connection.ack';
}

/**
 * Type guard for SubscriptionConfirmedEvent
 */
export function isSubscriptionConfirmedEvent(event: ServerEvent): event is SubscriptionConfirmedEvent {
  return event.type === 'subscription.confirmed';
}

/**
 * Type guard for ErrorEvent
 */
export function isErrorEvent(event: ServerEvent): event is ErrorEvent {
  return event.type === 'error';
}

/**
 * Type guard for PongEvent
 */
export function isPongEvent(event: ServerEvent): event is PongEvent {
  return event.type === 'pong';
}

/**
 * Check if an event is a feedback-related event
 */
export function isFeedbackEvent(
  event: ServerEvent
): event is FeedbackCreatedEvent | FeedbackUpdatedEvent | FeedbackDeletedEvent | FeedbackBulkUpdateEvent {
  return event.type.startsWith('feedback.');
}
