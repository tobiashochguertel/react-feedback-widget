version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR}}'
  LIB_DIR: '{{.ROOT_DIR}}/packages/react-visual-feedback'
  EXAMPLE_DIR: '{{.ROOT_DIR}}/packages/feedback-example'
  API_DIR: '{{.ROOT_DIR}}/packages/feedback-server-api'
  GENERATED_DIR: '{{.ROOT_DIR}}/packages/generated'

# Include child Taskfiles
includes:
  api:
    taskfile: ./packages/feedback-server-api/Taskfile.yml
    dir: ./packages/feedback-server-api
    optional: true

tasks:
  default:
    desc: Show available tasks (default)
    cmds:
      - task --list
    silent: true

  # ============================================================================
  # Code Generation (API-First)
  # ============================================================================

  generate:
    desc: Generate all API artifacts from TypeSpec
    summary: |
      Generates all code artifacts from the TypeSpec API specification:
      - OpenAPI 3.1 specification
      - TypeScript types (@feedback/api-types)
      - JavaScript client SDK (@feedback/api-client-js)
      - JSON Schemas (@feedback/api-schemas)
    cmds:
      - task: api:generate:all

  generate:types:
    desc: Generate TypeScript types only
    cmds:
      - task: api:generate:types

  generate:check:
    desc: Verify all generated files are up to date
    cmds:
      - task: api:check

  clean:generate:
    desc: Clean all generated files
    cmds:
      - task: api:clean

  # ============================================================================
  # Installation
  # ============================================================================

  install:
    desc: Install all workspace dependencies
    cmds:
      - bun install

  _ensure-deps:
    desc: Ensure dependencies are installed (internal)
    cmds:
      - bun install
    status:
      - test -f {{.LIB_DIR}}/node_modules/.bin/rollup
    silent: true

  # Library tasks
  build:
    desc: Build the react-visual-feedback library (TypeScript)
    deps: [_ensure-deps]
    dir: '{{.LIB_DIR}}'
    cmds:
      - bun run build
    sources:
      - '{{.LIB_DIR}}/src/**/*.{ts,tsx}'
      - '{{.LIB_DIR}}/rollup.config.ts'
      - '{{.LIB_DIR}}/tsconfig.json'
      - '{{.LIB_DIR}}/package.json'
    generates:
      - '{{.LIB_DIR}}/dist/**/*.js'

  build:watch:
    desc: Build library in watch mode
    deps: [_ensure-deps]
    dir: '{{.LIB_DIR}}'
    cmds:
      - bun run build:watch

  # Example tasks
  dev:
    desc: Start example app with live development
    deps: [build] # build already depends on _ensure-deps
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - bun run dev

  example:build:
    desc: Build example app
    deps: [build]
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - bun run build

  example:start:
    desc: Start example production server
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - bun run start

  # Development
  dev:full:
    desc: Run library build in watch mode and example dev server concurrently
    cmds:
      - task: build:watch
      - task: dev

  # Maintenance
  clean:
    desc: Clean all build artifacts
    cmds:
      - rm -rf {{.LIB_DIR}}/dist
      - rm -rf {{.EXAMPLE_DIR}}/.next
      - rm -rf node_modules
      - rm -rf {{.LIB_DIR}}/node_modules
      - rm -rf {{.EXAMPLE_DIR}}/node_modules

  clean:build:
    desc: Clean and rebuild everything
    cmds:
      - task: clean
      - task: install
      - task: build

  # ============================================================================
  # CI/CD
  # ============================================================================

  ci:
    desc: Run full CI pipeline
    summary: |
      Runs the complete CI pipeline:
      1. Install dependencies
      2. Generate API types
      3. Type check
      4. Lint
      5. Test
    cmds:
      - bun install --frozen-lockfile
      - task: generate
      - bun run --filter "*" typecheck
      - bun run --filter "*" lint
      - bun run --filter "*" test

  # ============================================================================
  # Server Tasks
  # ============================================================================

  server:dev:
    desc: Start feedback-server in development mode
    cmds:
      - bun run --filter "@react-visual-feedback/server" dev

  server:test:
    desc: Run feedback-server tests
    cmds:
      - bun run --filter "@react-visual-feedback/server" test

  server:build:
    desc: Build feedback-server
    cmds:
      - bun run --filter "@react-visual-feedback/server" build

  # Info
  info:
    desc: Show project information
    cmds:
      - echo "Workspace root = {{.ROOT_DIR}}"
      - echo "API package = {{.API_DIR}}"
      - echo "Generated packages = {{.GENERATED_DIR}}"
      - echo "Library = {{.LIB_DIR}}"
      - echo "Example = {{.EXAMPLE_DIR}}"
      - echo "Bun version = $(bun --version)"
      - echo "Node version = $(node --version)"

  # Testing
  check:
    desc: Run all checks (build, lint)
    cmds:
      - task: build
      - task: example:build

  # ============================================================================
  # Docker Compose - Deployment Orchestration
  # ============================================================================

  up:
    desc: Start all services with Docker Compose
    summary: |
      Starts the complete feedback system stack:
      - PostgreSQL database
      - Feedback Server (API)
      - Feedback WebUI (Dashboard)
      - Feedback Example (Demo app)
      
      Use 'task logs' to view logs.
      Use 'task down' to stop.
    cmds:
      - docker compose up -d
      - |
        echo ""
        echo "Services starting..."
        echo "  - PostgreSQL:      localhost:5432"
        echo "  - Feedback Server: http://localhost:3001"
        echo "  - Feedback WebUI:  http://localhost:5173"
        echo "  - Feedback Example: http://localhost:3002"
        echo ""
        echo "Run 'task logs' to view logs"

  down:
    desc: Stop all services
    cmds:
      - docker compose down

  restart:
    desc: Restart all services
    cmds:
      - docker compose restart

  logs:
    desc: View logs from all services
    cmds:
      - docker compose logs -f

  logs:server:
    desc: View logs from feedback-server only
    cmds:
      - docker compose logs -f feedback-server

  logs:webui:
    desc: View logs from feedback-webui only
    cmds:
      - docker compose logs -f feedback-webui

  logs:example:
    desc: View logs from feedback-example only
    cmds:
      - docker compose logs -f feedback-example

  status:
    desc: Show status of all services
    cmds:
      - docker compose ps

  health:
    desc: Check health of all services
    cmds:
      - |
        echo "Checking service health..."
        echo ""
        echo "PostgreSQL:"
        docker compose exec -T postgres pg_isready -U feedback || echo "  Not ready"
        echo ""
        echo "Feedback Server:"
        curl -sf http://localhost:3001/api/v1/health && echo " OK" || echo "  Not ready"
        echo ""
        echo "Feedback WebUI:"
        curl -sf http://localhost:5173/health && echo " OK" || echo "  Not ready"
        echo ""
        echo "Feedback Example:"
        curl -sf http://localhost:3002/ >/dev/null && echo "OK" || echo "  Not ready"

  # ============================================================================
  # Docker - Build Tasks
  # ============================================================================

  docker:build:
    desc: Build all Docker images
    cmds:
      - docker compose build

  docker:build:nocache:
    desc: Build all Docker images without cache
    cmds:
      - docker compose build --no-cache

  docker:build:server:
    desc: Build feedback-server Docker image
    cmds:
      - docker compose build feedback-server

  docker:build:webui:
    desc: Build feedback-webui Docker image
    cmds:
      - docker compose build feedback-webui

  docker:build:example:
    desc: Build feedback-example Docker image
    cmds:
      - docker compose build feedback-example

  docker:push:
    desc: Push all Docker images to registry
    summary: |
      Push images to the configured registry.
      Set DOCKER_REGISTRY in .env to specify the registry.
    cmds:
      - docker compose push

  # ============================================================================
  # Docker - Cleanup Tasks
  # ============================================================================

  reset:
    desc: Stop services and remove all volumes (fresh start)
    prompt: This will delete all data. Are you sure?
    cmds:
      - docker compose down -v
      - echo "All volumes removed. Next 'task up' will be a fresh start."

  prune:
    desc: Remove unused Docker resources
    cmds:
      - docker system prune -f
      - docker volume prune -f

  docker:clean:
    desc: Remove all project containers and images
    cmds:
      - docker compose down --rmi all -v

  # ============================================================================
  # Docker - Database Tasks
  # ============================================================================

  db:shell:
    desc: Open PostgreSQL shell
    cmds:
      - docker compose exec postgres psql -U feedback -d feedback

  db:backup:
    desc: Create database backup
    vars:
      BACKUP_FILE: 'backups/feedback-{{now | date "2006-01-02-150405"}}.sql'
    cmds:
      - mkdir -p backups
      - docker compose exec -T postgres pg_dump -U feedback feedback > {{.BACKUP_FILE}}
      - 'echo "Backup created: {{.BACKUP_FILE}}"'

  db:restore:
    desc: Restore database from backup
    summary: |
      Restore database from a backup file.
      
      Usage:
        task db:restore FILE=backups/feedback-2024-01-15.sql
    requires:
      vars: [FILE]
    cmds:
      - docker compose exec -T postgres psql -U feedback feedback < {{.FILE}}
      - 'echo "Database restored from {{.FILE}}"'

  # ============================================================================
  # Docker - Shell Access
  # ============================================================================

  shell:server:
    desc: Open shell in feedback-server container
    cmds:
      - docker compose exec feedback-server /bin/sh

  shell:webui:
    desc: Open shell in feedback-webui container
    cmds:
      - docker compose exec feedback-webui /bin/sh

  shell:example:
    desc: Open shell in feedback-example container
    cmds:
      - docker compose exec feedback-example /bin/sh
