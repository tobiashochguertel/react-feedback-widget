version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR}}'
  LIB_DIR: '{{.ROOT_DIR}}/packages/react-visual-feedback'
  EXAMPLE_DIR: '{{.ROOT_DIR}}/packages/feedback-example'
  API_DIR: '{{.ROOT_DIR}}/packages/feedback-server-api'
  GENERATED_DIR: '{{.ROOT_DIR}}/packages/generated'

# Include child Taskfiles
includes:
  api:
    taskfile: ./packages/feedback-server-api/Taskfile.yml
    dir: ./packages/feedback-server-api
    optional: true

tasks:
  default:
    desc: Show available tasks (default)
    cmds:
      - task --list
    silent: true

  # ============================================================================
  # Code Generation (API-First)
  # ============================================================================

  generate:
    desc: Generate all API artifacts from TypeSpec
    summary: |
      Generates all code artifacts from the TypeSpec API specification:
      - OpenAPI 3.1 specification
      - TypeScript types (@feedback/api-types)
      - JavaScript client SDK (@feedback/api-client-js)
      - JSON Schemas (@feedback/api-schemas)
    cmds:
      - task: api:generate:all

  generate:types:
    desc: Generate TypeScript types only
    cmds:
      - task: api:generate:types

  generate:check:
    desc: Verify all generated files are up to date
    cmds:
      - task: api:check

  clean:generate:
    desc: Clean all generated files
    cmds:
      - task: api:clean

  # ============================================================================
  # Installation
  # ============================================================================

  install:
    desc: Install all workspace dependencies
    cmds:
      - bun install

  _ensure-deps:
    desc: Ensure dependencies are installed (internal)
    cmds:
      - bun install
    status:
      - test -f {{.LIB_DIR}}/node_modules/.bin/rollup
    silent: true

  # Library tasks
  build:
    desc: Build the react-visual-feedback library (TypeScript)
    deps: [_ensure-deps]
    dir: '{{.LIB_DIR}}'
    cmds:
      - bun run build
    sources:
      - '{{.LIB_DIR}}/src/**/*.{ts,tsx}'
      - '{{.LIB_DIR}}/rollup.config.ts'
      - '{{.LIB_DIR}}/tsconfig.json'
      - '{{.LIB_DIR}}/package.json'
    generates:
      - '{{.LIB_DIR}}/dist/**/*.js'

  build:watch:
    desc: Build library in watch mode
    deps: [_ensure-deps]
    dir: '{{.LIB_DIR}}'
    cmds:
      - bun run build:watch

  # Example tasks
  dev:
    desc: Start example app with live development
    deps: [build] # build already depends on _ensure-deps
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - bun run dev

  example:build:
    desc: Build example app
    deps: [build]
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - bun run build

  example:start:
    desc: Start example production server
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - bun run start

  # Development
  dev:full:
    desc: Run library build in watch mode and example dev server concurrently
    cmds:
      - task: build:watch
      - task: dev

  # Maintenance
  clean:
    desc: Clean all build artifacts
    cmds:
      - rm -rf {{.LIB_DIR}}/dist
      - rm -rf {{.EXAMPLE_DIR}}/.next
      - rm -rf node_modules
      - rm -rf {{.LIB_DIR}}/node_modules
      - rm -rf {{.EXAMPLE_DIR}}/node_modules

  clean:build:
    desc: Clean and rebuild everything
    cmds:
      - task: clean
      - task: install
      - task: build

  # ============================================================================
  # CI/CD
  # ============================================================================

  ci:
    desc: Run full CI pipeline
    summary: |
      Runs the complete CI pipeline:
      1. Install dependencies
      2. Generate API types
      3. Type check
      4. Lint
      5. Test
    cmds:
      - bun install --frozen-lockfile
      - task: generate
      - bun run --filter "*" typecheck
      - bun run --filter "*" lint
      - bun run --filter "*" test

  # ============================================================================
  # Server Tasks
  # ============================================================================

  server:dev:
    desc: Start feedback-server in development mode
    cmds:
      - bun run --filter "@react-visual-feedback/server" dev

  server:test:
    desc: Run feedback-server tests
    cmds:
      - bun run --filter "@react-visual-feedback/server" test

  server:build:
    desc: Build feedback-server
    cmds:
      - bun run --filter "@react-visual-feedback/server" build

  # Info
  info:
    desc: Show project information
    cmds:
      - echo "Workspace root = {{.ROOT_DIR}}"
      - echo "API package = {{.API_DIR}}"
      - echo "Generated packages = {{.GENERATED_DIR}}"
      - echo "Library = {{.LIB_DIR}}"
      - echo "Example = {{.EXAMPLE_DIR}}"
      - echo "Bun version = $(bun --version)"
      - echo "Node version = $(node --version)"

  # Testing
  check:
    desc: Run all checks (build, lint)
    cmds:
      - task: build
      - task: example:build
