name: Feedback WebUI CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/feedback-server-webui/**'
      - 'packages/generated/feedback-api-types/**'
      - '.github/workflows/feedback-webui.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/feedback-server-webui/**'
      - 'packages/generated/feedback-api-types/**'
      - '.github/workflows/feedback-webui.yml'

defaults:
  run:
    working-directory: packages/feedback-server-webui

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (root)
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Install dependencies (webui)
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run typecheck
        continue-on-error: true

      - name: Lint
        run: bun run lint
        continue-on-error: true

  unit-tests:
    name: Unit & BDD Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (root)
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Install dependencies (webui)
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: bun run test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: packages/feedback-server-webui/coverage/
          retention-days: 7

  bdd-tests:
    name: BDD Tests (with Server)
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: feedback
          POSTGRES_PASSWORD: feedback
          POSTGRES_DB: feedback
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (root)
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Install dependencies (server)
        run: bun install --frozen-lockfile
        working-directory: packages/feedback-server

      - name: Install dependencies (webui)
        run: bun install --frozen-lockfile

      - name: Start feedback server
        run: bun run dev &
        working-directory: packages/feedback-server
        env:
          DATABASE_URL: postgresql://feedback:feedback@localhost:5432/feedback
          AUTH_ENABLED: false
          PORT: 3001

      - name: Wait for server
        run: |
          echo "Waiting for server to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:3001/health > /dev/null; then
              echo "Server is ready!"
              break
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 2
          done

      - name: Run BDD tests
        run: bun run test tests/bdd/
        env:
          API_BASE_URL: http://localhost:3001

      - name: Upload BDD test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bdd-test-results
          path: packages/feedback-server-webui/coverage/
          retention-days: 7

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (root)
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Install dependencies (webui)
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests (Chromium only in CI)
        run: npx playwright test --project=chromium
        continue-on-error: true

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            packages/feedback-server-webui/playwright-report/
            packages/feedback-server-webui/test-results/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (root)
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Install dependencies (webui)
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webui-build
          path: packages/feedback-server-webui/dist/
          retention-days: 7
